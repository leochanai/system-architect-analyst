import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'

// 处理 Obsidian 风格的图片链接，转换为标准 Markdown 格式
export function processObsidianImages(content: string): string {
  // 匹配 ![[image.jpg]] 格式
  const obsidianImagePattern = /!\[\[(.+?)\]\]/g

  return content.replace(obsidianImagePattern, (match, imageName) => {
    // 使用 API 路由来提供图片，避免中文文件名问题
    const imagePath = `/api/image?name=${encodeURIComponent(imageName)}`
    return `![${imageName}](${imagePath})`
  })
}

// 获取 MD 文件内容
export async function getDocContent(slug: string) {
  const docsDir = path.join(process.cwd(), 'docs')

  // 将 slug 转换为文件路径
  // 例如: "1-1" -> "第 1 章 考试介绍及备考攻略/1.1 架构师考试的相关情况.md"
  const chapterMap: Record<string, string> = {
    '1-1': '第 1 章 考试介绍及备考攻略/1.1 架构师考试的相关情况.md',
    '1-2': '第 1 章 考试介绍及备考攻略/1.2 架构师考试备考攻略.md',
    '2-1': '第 2 章 系统工程与信息系统基础/2.1 系统工程.md',
    '2-2': '第 2 章 系统工程与信息系统基础/2.2 信息系统生命周期.md',
    '2-3': '第 2 章 系统工程与信息系统基础/2.3 信息系统开发方法.md',
    '2-4': '第 2 章 系统工程与信息系统基础/2.4 信息系统的分类.md',
    '2-5': '第 2 章 系统工程与信息系统基础/2.5 政府信息化与电子政务.md',
    '2-6': '第 2 章 系统工程与信息系统基础/2.6 企业信息化与电子商务.md',
    '2-7': '第 2 章 系统工程与信息系统基础/2.7 数字化转型与智能制造.md',
    '3-1': '第 3 章 软件工程/3.1 软件过程模型.md',
    '3-2': '第 3 章 软件工程/3.2 基于构件的软件工程.md',
    '3-3': '第 3 章 软件工程/3.3 统一过程.md',
    '3-4': '第 3 章 软件工程/3.4 敏捷方法.md',
    '3-5': '第 3 章 软件工程/3.5 逆向工程.md',
    '3-6': '第 3 章 软件工程/3.6 净室软件工程.md',
    '3-7': '第 3 章 软件工程/3.7 需求工程.md',
    '3-8': '第 3 章 软件工程/3.8 系统分析与设计.md',
    '3-9': '第 3 章 软件工程/3.9 软件测试.md',
    '3-10': '第 3 章 软件工程/3.10 系统运行与软件维护.md',
    '4-1': '第 4 章 项目管理/4.1 盈亏平衡分析.md',
    '4-2': '第 4 章 项目管理/4.2 进度管理.md',
    '4-3': '第 4 章 项目管理/4.3 软件质量管理.md',
    '4-4': '第 4 章 项目管理/4.4 软件配置管理.md',
    '5-1': '第 5 章 软件架构设计/5.1 软件架构的概念.md',
    '5-2': '第 5 章 软件架构设计/5.2 基于架构的软件开发.md',
    '5-3': '第 5 章 软件架构设计/5.3 软件架构风格.md',
    '5-4': '第 5 章 软件架构设计/5.4 特定领域软件架构.md',
    '5-5': '第 5 章 软件架构设计/5.5 软件质量属性.md',
    '5-6': '第 5 章 软件架构设计/5.6 软件架构评估.md',
    '5-7': '第 5 章 软件架构设计/5.7 构件与中间件技术.md',
    '5-8': '第 5 章 软件架构设计/5.8 层次型软件架构风格.md',
    '5-9': '第 5 章 软件架构设计/5.9 面向服务的软件架构风格.md',
    '5-10': '第 5 章 软件架构设计/5.10 云原生架构风格.md',
    '5-11': '第 5 章 软件架构设计/5.11 大型网站系统架构演化.md',
    '6-1': '第 6 章 系统可靠性分析与设计/6.1 可靠性相关基本概念.md',
    '6-2': '第 6 章 系统可靠性分析与设计/6.2 系统可靠性分析.md',
    '6-3': '第 6 章 系统可靠性分析与设计/6.3 软件可靠性设计.md',
    '7-1': '第 7 章 信息安全技术基础知识/7.1 信息安全基础.md',
    '7-2': '第 7 章 信息安全技术基础知识/7.2 信息加解密技术.md',
    '7-3': '第 7 章 信息安全技术基础知识/7.3 访问控制及数字签名技术.md',
    '7-4': '第 7 章 信息安全技术基础知识/7.4 密钥管理技术.md',
    '7-5': '第 7 章 信息安全技术基础知识/7.5 信息安全的保障体系.md',
    '8-1': '第 8 章 计算机系统基础/8.1 计算机系统组成.md',
    '8-2': '第 8 章 计算机系统基础/8.2 操作系统概述.md',
    '8-3': '第 8 章 计算机系统基础/8.3 进程管理.md',
    '8-4': '第 8 章 计算机系统基础/8.4 存储管理.md',
    '8-5': '第 8 章 计算机系统基础/8.5 磁盘管理.md',
    '8-6': '第 8 章 计算机系统基础/8.6 文件系统.md',
    '8-7': '第 8 章 计算机系统基础/8.7 系统配置与性能评价.md',
    '9-1': '第 9 章 嵌入式技术/9.1 嵌入式系统概述.md',
    '9-2': '第 9 章 嵌入式技术/9.2 嵌入式硬件.md',
    '9-3': '第 9 章 嵌入式技术/9.3 嵌入式操作系统.md',
    '9-4': '第 9 章 嵌入式技术/9.4 嵌入式数据库.md',
    '9-5': '第 9 章 嵌入式技术/9.5 嵌入式软件开发.md',
    '10-1': '第 10 章 计算机网络/10.1 通信系统架构.md',
    '10-2': '第 10 章 计算机网络/10.2 组网技术.md',
    '10-3': '第 10 章 计算机网络/10.3 TCPIP协议族.md',
    '10-4': '第 10 章 计算机网络/10.4 网络规划与设计.md',
    '11-1': '第 11 章 数据库系统/11.1 数据库模式.md',
    '11-2': '第 11 章 数据库系统/11.2 分布式数据库.md',
    '11-3': '第 11 章 数据库系统/11.3 数据库设计阶段.md',
    '11-4': '第 11 章 数据库系统/11.4 概念结构设计-ER模型.md',
    '11-5': '第 11 章 数据库系统/11.5 逻辑结构设计-关系模式.md',
    '11-6': '第 11 章 数据库系统/11.6 关系代数.md',
    '11-7': '第 11 章 数据库系统/11.7 规范化理论.md',
    '11-8': '第 11 章 数据库系统/11.8 并发控制.md',
    '11-9': '第 11 章 数据库系统/11.9 数据库的安全性.md',
    '11-10': '第 11 章 数据库系统/11.10 数据库性能优化.md',
    '12-1': '第 12 章 未来信息综合技术/12.1 信息物理系统 CPS.md',
    '12-2': '第 12 章 未来信息综合技术/12.2 人工智能技术.md',
    '12-3': '第 12 章 未来信息综合技术/12.3 机器人技术.md',
    '12-4': '第 12 章 未来信息综合技术/12.4 数字孪生体技术.md',
    '12-5': '第 12 章 未来信息综合技术/12.5 大数据技术.md',
    '13-1': '第 13 章 知识产权与标准化/13.1 保护范围与对象.md',
    '13-2': '第 13 章 知识产权与标准化/13.2 保护期限.md',
    '13-3': '第 13 章 知识产权与标准化/13.3 知识产权人确定.md',
    '13-4': '第 13 章 知识产权与标准化/13.4 侵权判断.md',
    '13-5': '第 13 章 知识产权与标准化/13.5 标准化.md',
    '14-1': '第 14 章 案例特训专题/14.1 考纲分析.md',
    '14-2': '第 14 章 案例特训专题/14.2 历年试题分析.md',
    '14-3': '第 14 章 案例特训专题/14.3 如何解答试题.md',
    '15-1': '第 15 章 论文写作技巧篇/15.1 考试大纲+考情分析.md',
    '15-2': '第 15 章 论文写作技巧篇/15.2 备考策略.md',
    '15-3': '第 15 章 论文写作技巧篇/15.3 论文写作四部曲.md',
    '15-4': '第 15 章 论文写作技巧篇/15.4 论文写作准则.md',
    '16-1': '第 16 章 其它资源/16.1 练习题资源.md'
  }

  const filePath = chapterMap[slug]
  if (!filePath) {
    return null
  }

  const fullPath = path.join(docsDir, filePath)

  try {
    const fileContent = fs.readFileSync(fullPath, 'utf-8')
    const { data, content } = matter(fileContent)

    // 处理 Obsidian 风格的图片链接
    const processedContent = processObsidianImages(content)

    return {
      metadata: data,
      content: processedContent
    }
  } catch (error) {
    console.error('Error reading file:', error)
    return null
  }
}
